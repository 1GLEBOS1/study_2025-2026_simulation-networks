---
## Author
author:
  name: Поляков Глеб Сергеевич
  orcid: 0000-0002-0877-7063
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Лабораторная работа №5"
subtitle: "Эмуляция и измерение потерь потоков в глобальных сетях"
license: "CC BY"
---

# Цель работы

Основной целью работы является получение навыков проведения интерактивных экспериментов в среде Mininet по исследованию параметров сети, связанных с потерей, дублированием, изменением порядка и повреждением пакетов при передаче данных. Эти параметры влияют на производительность протоколов и сетей.

# Задание

1. Задайте простейшую топологию, состоящую из двух хостов и коммутатора с назначенной по умолчанию mininet сетью 10.0.0.0/8.
2. Проведите интерактивные эксперименты по по исследованию параметров сети, связанных с потерей, дублированием, изменением порядка и повреждением пакетов при передаче данных.
3. Реализуйте воспроизводимый эксперимент по добавлению правила отбрасывания пакетов в эмулируемой глобальной сети. На экран выведите сводную информацию о потерянных пакетах.
4. Самостоятельно реализуйте воспроизводимые эксперименты по исследованию параметров сети, связанных с потерей, изменением порядка и повреждением пакетов при передаче данных. На экран выведите сводную информацию о потерянных пакетах.

# Выполнение лабораторной работы

## 5.4.1. Запуск лабораторной топологии
1. Запустите виртуальную среду с mininet.

2. Из основной ОС подключитесь к виртуальной машине:
    1 ssh -Y mininet@192.168.x.y
![Подключение к виртуальной машине](image/image_1.png){#fig-001 width=70%}

3. В виртуальной машине mininet при необходимости исправьте права запуска X-соединения. Скопируйте значение куки (MIT magic cookie) своего пользователя mininet в файл для пользователя root:
    1 mininet@mininet-vm:~$ xauth list $DISPLAY
    2 mininet-vm/unix:10 MIT-MAGIC-COOKIE-1 295acad8e35d17636924c5ab80e8462d
    3
    4 mininet@mininet-vm:~$ sudo -i
    5 root@mininet-vm:~# xauth add mininet-vm/unix:10 MIT-MAGIC-COOKIE-1 295acad8e35d17636924c5ab80e8462d
    6 root@mininet-vm:~# logout
После выполнения этих действий графические приложения должны запускаться под пользователем mininet.
![Настройка X-соединения](image/image_2.png){#fig-002 width=70%}

4. Задайте простейшую топологию, состоящую из двух хостов и коммутатора с назначенной по умолчанию mininet сетью 10.0.0.0/8:
    1 sudo mn --topo=single,2 -x
После введения этой команды запустятся терминалы двух хостов, коммутатора и контроллера. Терминалы коммутатора и контроллера можно закрыть.
![Включение mininet](image/image_4.png){#fig-003 width=70%}

5. На хостах h1 и h2 введите команду ifconfig, чтобы отобразить информацию, относящуюся к их сетевым интерфейсам и назначенным им IP-адресам. В дальнейшем при работе с NETEM и командой tc будут использоваться интерфейсы h1-eth0 и h2-eth0.
![h1 ifconfig](image/image_5.png){#fig-004 width=70%}
![h2 ifconfig](image/image_6.png){#fig-005 width=70%}
6. Проверьте подключение между хостами h1 и h2 с помощью команды ping с параметром -c 6.
![ping](image/image_7.png){#fig-006 width=70%}
7. Укажите в отчёте минимальное, среднее, максимальное и стандартное отклонение времени приёма-передачи (RTT), информацию о наличии или отсутствии потерь данных.
Минимальное 0.068ms, среднее 2.149ms, максимальное 12.044ms, стандартное отклонение 4.427ms, потери данных 0%

## 5.4.2. Интерактивные эксперименты
### 5.4.2.1. Добавление потери пакетов на интерфейс, подключённый к эмулируемой глобальной сети

Пакеты могут быть потеряны в процессе передачи из-за таких факторов, как битовые ошибки и перегрузка сети. Скорость потери данных часто измеряется как процентная доля потерянных пакетов по отношению к количеству отправленных пакетов.

1. На хосте h1 добавьте 10% потерь пакетов к интерфейсу h1-eth0:
    1 sudo tc qdisc add dev h1-eth0 root netem loss 10%
![Добавление потери пакетов h1](image/image_9.png){#fig-008 width=70%}
Здесь:
- sudo: выполнить команду с более высокими привилегиями;
- tc: вызвать управление трафиком Linux;
- qdisc: изменить дисциплину очередей сетевого планировщика;
- add: создать новое правило;
- dev h1-eth0: указать интерфейс, на котором будет применяться правило;
- netem: использовать эмулятор сети;
- loss 10%: 10% потерь пакетов.

2. Проверьте, что на соединении от хоста h1 к хосту h2 имеются потери пакетов, используя команду ping с параметром -c 100 с хоста h1. Параметр -c указывает общее количество пакетов для отправки. Обратите внимание на значения icmp_seq. Некоторые номера последовательности отсутствуют изза потери пакетов. В сводном отчёте ping сообщает о проценте потерянных пакетов после завершения передачи.
![Проверка](image/image_10.png){#fig-009 width=70%}

3. Для эмуляции глобальной сети с потерей пакетов в обоих направлениях необходимо к соответствующему интерфейсу на хосте h2 также добавить 10% потерь пакетов:
    1 sudo tc qdisc add dev h2-eth0 root netem loss 10%
![Добавление потери потоков h2](image/image_11.png){#fig-010 width=70%}
4. Проверьте, что соединение между хостом h1 и хостом h2 имеет больший процент потерянных данных (10% от хоста h1 к хосту h2 и 10% от хоста h2 к хосту h1), повторив команду ping с параметром -c 100 на терминале хоста h1.
![Проверка](image/image_12.png){#fig-011 width=70%}
Укажите в отчёте отсутствующие из-за потери пакетов номера последовательности (значения icmp_seq), процент потерянных пакетов после завершения передачи.
Потери данных 17%, недостающие номера пакетов icmp: 4, 8, 12, 14, 16, 17, 19, 27 ... 91, 99.

5. Восстановите конфигурацию по умолчанию, удалив все правила, применённые к сетевому планировщику соответствующего интерфейса. Для отправителя h1:
    1 sudo tc qdisc del dev h1-eth0 root netem
![Восстановление](image/image_14.png){#fig-012 width=70%}
Для получателя h2:
    1 sudo tc qdisc del dev h2-eth0 root netem
![Восстановление](image/image_13.png){#fig-013 width=70%}

6. Убедитесь, что соединение от хоста h1 к хосту h2 не имеет явной потери пакетов, запустив команду ping с терминала хоста h1 и затем нажав Ctrl + c , чтобы остановить тест.
![Проверка](image/image_15.png){#fig-014 width=70%}
### 5.4.2.2. Добавление значения корреляции для потери пакетов в эмулируемой глобальной сети

1. Добавьте на интерфейсе узла h1 коэффициент потери пакетов 50% (такой высокий уровень потери пакетов маловероятен), и каждая последующая вероятность зависит на 50% от последней:
    1 sudo tc qdisc add dev h1-eth0 root netem loss 50% 50%
![Добавление потери пакетов](image/image_16.png){#fig-015 width=70%}
2. Проверьте, что на соединении от хоста h1 к хосту h2 имеются потери пакетов, используя команду ping с параметром -c 50 с хоста h1. Укажите в отчёте отсутствующие из-за потери пакетов номера последовательности (значения icmp_seq), процент потерянных пакетов после завершения передачи.
![Проверка соединения](image/image_17.png){#fig-016 width=70%}
Процент потерь 38%, потерянные пакеты ... 44, 45, 46, 48, 49
3. Восстановите для узла h1 конфигурацию по умолчанию, удалив все правила, применённые к сетевому планировщику соответствующего интерфейса:
    1 sudo tc qdisc del dev h1-eth0 root netem
![Восстановление конфигурации](image/image_18.png){#fig-017 width=70%}
### 5.4.2.3. Добавление повреждения пакетов в эмулируемой глобальной сети

1. При необходимости восстановите конфигурацию интерфейсов по умолчанию на узлах h1 и h2.

2. Добавьте на интерфейсе узла h1 0,01% повреждения пакетов:
    1 sudo tc qdisc add dev h1-eth0 root netem corrupt 0.01%
![Добавление](image/image_19.png){#fig-018 width=70%}
3. Проверьте конфигурацию с помощью инструмента iPerf3 для проверки повторных передач. Для этого:
- запустите iPerf3 в режиме сервера в терминале хоста h2:
    1 iperf3 -s
![Проверка](image/image_20.png){#fig-019 width=70%}
- запустите iPerf3 в клиентском режиме в терминале хоста h1:
    1 iperf3 -c 10.0.0.2
![Проверка](image/image_21.png){#fig-020 width=70%}
- В отчёте отразите значения повторной передачи на каждом временном интервале и общее количество повторно переданных пакетов.
0.0-10.0 sec 7.13 GBytes
- Для остановки сервера iPerf3 нажмите Ctrl + c в терминале хоста h2.

4. Восстановите для узла h1 конфигурацию по умолчанию, удалив все правила, применённые к сетевому планировщику соответствующего интерфейса.
![Восстановление](image/image_22.png){#fig-021 width=70%}
### 5.4.2.4. Добавление переупорядочивания пакетов в интерфейс подключения к эмулируемой глобальной сети

1. При необходимости восстановите конфигурацию интерфейсов по умолчанию на узлах h1 и h2.

2. Добавьте на интерфейсе узла h1 следующее правило:
    1 sudo tc qdisc add dev h1-eth0 root netem delay 10ms reorder 25% 50%

![Добавление правила](image/image_23.png){#fig-022 width=70%}
Здесь 25% пакетов (со значением корреляции 50%) будут отправлены немедленно, а остальные 75% будут задержаны на 10 мс.

3. Проверьте, что на соединении от хоста h1 к хосту h2 имеются потери пакетов, используя команду ping с параметром -c 20 с хоста h1. Убедитесь, что часть пакетов не будут иметь задержки (один из четырех, или 25%), а последующие несколько пакетов будут иметь задержку около 10 миллисекунд (три из четырех, или 75%). При необходимости повторите тест. Укажите в отчёте отсутствующие из-за потери пакетов номера последовательности (значения icmp_seq), процент потерянных пакетов после завершения передачи.

![Проверка](image/image_24.png){#fig-023 width=70%}
Процент потерь 0%, пропущенных пакетов 0
4. Восстановите конфигурацию интерфейса по умолчанию на узле h1.

### 5.4.2.5. Добавление дублирования пакетов в интерфейс подключения к эмулируемой глобальной сети

1. При необходимости восстановите конфигурацию интерфейсов по умолчанию на узлах h1 и h2.

2. Для интерфейса узла h1 задайте правило c дублированием 50% пакетов (т.е. 50% пакетов должны быть получены дважды):
    1 sudo tc qdisc add dev h1-eth0 root netem duplicate 50%
![Настройка](image/image_25.png){#fig-024 width=70%}

3. Проверьте, что на соединении от хоста h1 к хосту h2 имеются дублированные пакеты, используя команду ping с параметром -c 20 с хоста h1. Дубликаты пакетов помечаются как DUP!. Измеренная скорость дублирования пакетов будет приближаться к настроенной скорости по мере выполнения большего количества попыток.
![Проверка](image/image_26.png){#fig-025 width=70%}

4. Восстановите конфигурацию интерфейса по умолчанию на узле h1.

## 5.4.3. Воспроизведение экспериментов
### 5.4.3.1. Предварительная подготовка

1. Для каждого воспроизводимого эксперимента expname создайте свой каталог, в котором будут размещаться файлы эксперимента:
    1 mkdir -p ~/work/lab_netem_ii/expname
Здесь expname может принимать значения simple-drop, correlationdrop и т.п.

2. Для каждого случая создайте скрипт для проведения эксперимента lab_netem_ii.py.

### 5.4.3.2. Добавление потери пакетов на интерфейс, подключённый к эмулируемой глобальной сети

С помощью API Mininet воспроизведите эксперимент по добавлению потери пакетов для интерфейса хоста, подключающегося к эмулируемой глобальной сети.

1. В виртуальной среде mininet в своём рабочем каталоге с проектами создайте каталог simple-drop и перейдите в него:
    1 mkdir -p ~/work/lab_netem_ii/simple-drop
    2 cd ~/work/lab_netem_ii/simple-drop

2. Создаёте скрипт для эксперимента lab_netem_ii.py:

        #!/usr/bin/env python
        '''
        Simple experiment.
        Output: ping.dat
        '''

        from mininet.net import Mininet
        from mininet.node import Controller
        from mininet.cli import CLI
        from mininet.log import setLogLevel, info
        import time

        def emptyNet():
            "Create an empty network and add nodes to it."
            net = Mininet( controller=Controller, waitConnected=True )
            info( '*** Adding controller\n' )
            net.addController( 'c0' )
            info( '*** Adding hosts\n' )
            h1 = net.addHost( 'h1', ip='10.0.0.1' )
            h2 = net.addHost( 'h2', ip='10.0.0.2' )
            info( '*** Adding switch\n' )
            s1 = net.addSwitch( 's1' )
            info( '*** Creating links\n' )
            net.addLink( h1, s1 )
            net.addLink( h2, s1 )
            info( '*** Starting network\n')
            net.start()
            info( '*** Set delay\n')
            h1.cmdPrint( 'tc qdisc add dev h1-eth0 root netem loss 10%' )
            h2.cmdPrint( 'tc qdisc add dev h2-eth0 root netem loss 10%' )
            info( '*** Ping\n')
            time.sleep(10) # Wait 10 seconds
            h1.cmdPrint( 'ping -c 100', h2.IP(), '| grep "time=" | awk \'{print $5, $7}\' | sed -e \'s/time=//g\' -e \'s/icmp_seq=//g\' > ping.dat' )
            info( '*** Stopping network' )
            net.stop()

        if __name__ == '__main__':
            setLogLevel( 'info' )
            emptyNet()
        '''

![Файл](image/image_27.png){#fig-026 width=70%}
3. В отчёте поясните содержание скрипта lab_netem_ii.py. В каких строках скрипта задается значение потери пакетов для интерфейса хоста?

4. Скорректируйте скрипт так, чтобы на экран или в отдельный файл выводилась информация о потерях пакетов.

5. Создайте Makefile для управления процессом проведения эксперимента:
    1 all: ping.dat
    2
    3 ping.dat:
    4 sudo python lab_netem_ii.py
    5 sudo chown mininet:mininet ping.dat
    6
    7 clean:
    8 -rm -f *.dat

6. Выполните эксперимент:
    1 make

7. Очистите каталог от результатов проведения экспериментов:
    1 make clean

![Тест 1](image/ping_simple.png){#fig- width=70%}

![Тест 2](image/ping_loss_50_50.png){#fig- width=70%}

![Тест 3](image/ping_corrupt.png){#fig- width=70%}

![Тест 4](image/ping_reorder.png){#fig- width=70%}

![Тест 5](image/ping_duplicate.png){#fig- width=70%}

# Выводы

Получил навыки проведения интерактивных экспериментов в среде Mininet по исследованию параметров сети, связанных с потерей, дублированием, изменением порядка и повреждением пакетов при передаче данных. Эти параметры влияют на производительность протоколов и сетей.

# Список литературы{.unnumbered}

::: {#refs}
:::
